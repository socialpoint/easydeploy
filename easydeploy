#! /usr/bin/python

import argparse
import re
import os
import sys
import json


root = './var/local/easydeploy'
cacheroot = root + '/cache'
tmpfolder = './tmp/easydeploy/' + str(os.getpid())
dbfile = root + '/db.json'
if (os.path.exists(dbfile)):
    f = open(dbfile, 'r')
    db = json.load(f)
    f.close()
else:
    db = json.loads('{}')

print tmpfolder
os.makedirs(tmpfolder)

print tmpfolder


parser = argparse.ArgumentParser(description='Deploy a package.')

parser.add_argument('-c', help='check if already installed (if alrady installed, dont install again)')
parser.add_argument('-u', help='dont update if already exists a version', type=int, default=1)
parser.add_argument('-i', help='dont install, only update cache')
parser.add_argument('url', help='url of the package to install (git, s3, http)')

args = parser.parse_args()

url = args.url
cachepath = cacheroot + '/' + re.sub('[@:?/]+','/',url)
if re.match('s3://', url):
    print 's3'
    filename = tmpfolder + '/file.tar.gz'
    os.system('s3cmd get ' + url + ' ' + filename)
    os.system('rm -rf ' + cachepath)
    os.makedirs(cachepath)
    os.system('tar xvfz ' + filename + ' -C ' + cachepath)
elif re.match('http(s?)://', url):
    print 'http'
else:
    print 'git'
    if (os.path.exists(cachepath + '/.git')):
        if (args.u):
            os.chdir(cachepath)
            os.system('git reset --hard HEAD')
            os.system('git pull')
            os.system('git checkout master')
    else:
        os.system('rm -rf ' + cachepath)
        os.makedirs(cachepath)
        os.system('git clone ' + url + ' ' + cachepath)    

print cachepath

f = open(dbfile, 'w')
json.dump(db, f)
f.close()